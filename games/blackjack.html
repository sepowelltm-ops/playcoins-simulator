<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blackjack</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <h1>Blackjack</h1>
  <div id="balance">Coins: 0</div>
  <div id="message"></div>

  <div id="game">
    <div>
      <h2>Your Hand (<span id="player-score">0</span>)</h2>
      <div id="player-cards"></div>
    </div>

    <div>
      <h2>Dealer's Hand (<span id="dealer-score">0</span>)</h2>
      <div id="dealer-cards"></div>
    </div>

    <div id="controls">
      <button id="hit-btn">Hit</button>
      <button id="stand-btn">Stand</button>
      <button id="double-btn">Double</button>
      <input type="number" id="bet-amount" placeholder="Bet coins" min="1" />
      <button id="start-btn">Start Game</button>
    </div>
  </div>

  <script>
    // ----------------------------
    // GLOBALS
    // ----------------------------
    let playerHand = [];
    let dealerHand = [];
    let deck = [];
    let playerScore = 0;
    let dealerScore = 0;
    let dealerHiddenCard = null;
    let playerBalance = 0;
    const balanceEl = document.getElementById('balance');
    const messageEl = document.getElementById('message');

    // Load balance
    const accounts = JSON.parse(localStorage.getItem('accounts')) || {};
    const currentUser = localStorage.getItem('currentUser');
    if (currentUser && accounts[currentUser]) {
      playerBalance = accounts[currentUser].balance;
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      balanceEl.textContent = `Coins: ${playerBalance}`;
    }

    // ----------------------------
    // DECK FUNCTIONS
    // ----------------------------
    const suits = ['♠','♥','♦','♣'];
    const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

    function createDeck() {
      deck = [];
      for (let suit of suits) {
        for (let value of values) {
          deck.push({suit, value});
        }
      }
      deck = shuffle(deck);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function dealCard(hand) {
      hand.push(deck.pop());
      return hand[hand.length-1];
    }

    function calculateScore(hand) {
      let score = 0;
      let aces = 0;
      for (let card of hand) {
        if (['J','Q','K'].includes(card.value)) score += 10;
        else if (card.value === 'A') {
          score += 11;
          aces++;
        } else score += Number(card.value);
      }
      while (score > 21 && aces > 0) {
        score -= 10;
        aces--;
      }
      return score;
    }

    // ----------------------------
    // RENDER HANDS
    // ----------------------------
    function renderHands(showDealerFull=false) {
      document.getElementById('player-cards').textContent = playerHand.map(c => `${c.value}${c.suit}`).join(' ');

      if (showDealerFull) {
        document.getElementById('dealer-cards').textContent = dealerHand.map(c => `${c.value}${c.suit}`).join(' ');
      } else {
        // show first card + hidden
        const first = dealerHand[0];
        document.getElementById('dealer-cards').textContent = `${first.value}${first.suit} ??`;
      }

      playerScore = calculateScore(playerHand);
      dealerScore = calculateScore(dealerHand);
      document.getElementById('player-score').textContent = playerScore;
      document.getElementById('dealer-score').textContent = showDealerFull ? dealerScore : "?";
    }

    // ----------------------------
    // GAME LOGIC
    // ----------------------------
    let currentBet = 0;
    let gameActive = false;

    document.getElementById('start-btn').addEventListener('click', () => {
      if (!currentUser) return alert("Login to play!");
      const bet = Number(document.getElementById('bet-amount').value);
      if (!bet || bet > playerBalance) return alert("Invalid bet!");
      currentBet = bet;

      playerHand = [];
      dealerHand = [];
      createDeck();

      dealCard(playerHand);
      dealCard(playerHand);
      dealCard(dealerHand);
      dealerHiddenCard = dealCard(dealerHand);

      renderHands(false);
      messageEl.textContent = "Game started! Hit or Stand?";
      gameActive = true;

      // Check for immediate Blackjack
      const playerScoreInit = calculateScore(playerHand);
      const dealerScoreInit = calculateScore(dealerHand);
      if (playerScoreInit === 21 && dealerScoreInit === 21) return endGame("Push! Both have Blackjack");
      if (playerScoreInit === 21) return endGame("Blackjack! You win!");
      if (dealerScoreInit === 21) return endGame("Dealer has Blackjack! You lose!");
    });

    document.getElementById('hit-btn').addEventListener('click', () => {
      if (!gameActive) return;
      dealCard(playerHand);
      renderHands(false);
      if (calculateScore(playerHand) > 21) endGame("Bust! You lose.");
    });

    document.getElementById('stand-btn').addEventListener('click', () => {
      if (!gameActive) return;
      // reveal dealer
      renderHands(true);

      while (calculateScore(dealerHand) < 17) {
        dealCard(dealerHand);
        renderHands(true);
      }

      const pScore = calculateScore(playerHand);
      const dScore = calculateScore(dealerHand);

      if (dScore > 21 || pScore > dScore) endGame("You win!");
      else if (pScore < dScore) endGame("Dealer wins!");
      else endGame("Push!");
    });

    document.getElementById('double-btn').addEventListener('click', () => {
      if (!gameActive) return;
      if (currentBet*2 > playerBalance) return alert("Not enough coins to double!");
      currentBet *= 2;
      dealCard(playerHand);
      renderHands(false);
      if (calculateScore(playerHand) > 21) endGame("Bust! You lose.");
      else document.getElementById('stand-btn').click();
    });

    function endGame(msg) {
      gameActive = false;
      renderHands(true); // reveal dealer
      messageEl.textContent = msg;
      if (msg.includes("win") || msg.includes("Blackjack! You win!")) playerBalance += currentBet;
      else if (msg.includes("lose") || msg.includes("Bust") || msg.includes("Dealer wins")) playerBalance -= currentBet;
      updateBalanceDisplay();

      // Save to localStorage
      accounts[currentUser].balance = playerBalance;
      localStorage.setItem('accounts', JSON.stringify(accounts));
    }
  </script>
</body>
</html>
