<script>
const balanceEl = document.getElementById('balance');
const messageEl = document.getElementById('message');
const multiplierEl = document.getElementById('multiplier-display');

const accounts = JSON.parse(localStorage.getItem('accounts')) || {};
const currentUser = localStorage.getItem('currentUser');

let playerBalance = currentUser && accounts[currentUser]
  ? accounts[currentUser].balance
  : 0;

updateBalance();

let betAmount = 0;
let multiplier = 1;
let interval = null;
let crashed = false;

function updateBalance() {
  balanceEl.textContent = `Coins: ${playerBalance}`;
}

/* ---------------- START GAME ---------------- */
document.getElementById('start-btn').onclick = () => {
  if (!currentUser) return alert("Login first");

  betAmount = Number(document.getElementById('bet-amount').value);
  if (!betAmount || betAmount > playerBalance) return alert("Invalid bet");

  multiplier = 1;
  crashed = false;
  multiplierEl.textContent = "Multiplier: x1.00";
  messageEl.textContent = "Crash startedâ€¦";

  document.getElementById('start-btn').disabled = true;
  document.getElementById('cashout-btn').disabled = false;

  const betRatio = betAmount / playerBalance; // BIG factor

  /* ðŸ’€ HOUSE BIAS */
  const maxCrash = Math.max(
    1.2,
    5 - (betRatio * 6)      // higher bet â†’ much lower ceiling
  );

  let crashPoint =
    Math.random() * (maxCrash - 1.05) + 1.05;

  // Big bets have a chance to instantly crash
  if (betRatio > 0.4 && Math.random() < betRatio) {
    crashPoint = 1 + Math.random() * 0.15;
  }

  // Speed increases with bet size
  const speed = Math.max(
    20,
    80 - betRatio * 100
  );

  runCrash(crashPoint, speed);
};

/* ---------------- CRASH LOOP ---------------- */
function runCrash(crashPoint, speed) {
  interval = setInterval(() => {
    if (crashed) return clearInterval(interval);

    multiplier += 0.01 + multiplier * 0.002;
    multiplierEl.textContent = `Multiplier: x${multiplier.toFixed(2)}`;

    if (multiplier >= crashPoint) {
      doCrash();
    }
  }, speed);
}

/* ---------------- CASHOUT ---------------- */
document.getElementById('cashout-btn').onclick = () => {
  if (crashed) return;

  crashed = true;
  clearInterval(interval);

  const winnings = Math.floor(betAmount * multiplier);
  playerBalance += winnings;

  accounts[currentUser].balance = playerBalance;
  localStorage.setItem('accounts', JSON.stringify(accounts));

  messageEl.textContent =
    `Cashed out at x${multiplier.toFixed(2)} â€” won ${winnings} coins`;

  endGame();
};

/* ---------------- LOSE ---------------- */
function doCrash() {
  crashed = true;
  clearInterval(interval);

  playerBalance -= betAmount;
  accounts[currentUser].balance = playerBalance;
  localStorage.setItem('accounts', JSON.stringify(accounts));

  messageEl.textContent =
    `ðŸ’¥ Crashed at x${multiplier.toFixed(2)} â€” lost ${betAmount} coins`;

  endGame();
}

function endGame() {
  updateBalance();
  document.getElementById('cashout-btn').disabled = true;
  document.getElementById('start-btn').disabled = false;
}
</script>
